# FOC 电机控制 - 未来开发计划

## 1. 串口命令解析

**目标**: 实现运行时参数调整和状态查询

**功能点**:
- 命令格式设计 (如 `SET SPD 3000`, `GET PID`)
- 目标值设置: 转速、电流、位置
- PID 参数在线调整
- 控制模式切换
- 状态查询与故障码读取

**实现思路**:
- 基于 FIFO 的串口接收缓冲
- 简单的命令解析器 (字符串匹配或状态机)
- 命令回调函数表

---

## 2. 位置闭环控制

**目标**: 实现精确角度/位置定位

**功能点**:
- 位置环 PID 控制器
- 位置指令规划 (梯形/S曲线)
- 多圈位置累计
- 位置到达判断与保持

**控制结构**:
```
位置环 → 速度环 → 电流环 → SVPWM
```

**关键参数**:
- 位置环 Kp (速度环带宽的 1/5~1/10)
- 位置误差死区
- 最大跟踪速度限制

---

## 3. 滑模观测器 (SMO)

**目标**: 实现无传感器 FOC 控制

**功能点**:
- 反电动势估算
- 电角度/转速估算
- 锁相环 (PLL) 角度跟踪
- 低速启动策略 (I/F 启动 → SMO 切换)

**数学模型**:
```
î_α = ∫[(v_α - R·i_α - e_α + k·sign(î_α - i_α)) / L] dt
î_β = ∫[(v_β - R·i_β - e_β + k·sign(î_β - i_β)) / L] dt
```

**难点**:
- 滑模增益选择
- 低速时反电动势信噪比差
- 启动到闭环的平滑切换

---

## 4. 前馈解耦

**目标**: 消除 dq 轴交叉耦合，提升动态响应

**原理**:
电机 dq 轴方程存在耦合项:
- d轴: `v_d = R·i_d + L_d·di_d/dt - ω_e·L_q·i_q`
- q轴: `v_q = R·i_q + L_q·di_q/dt + ω_e·L_d·i_d + ω_e·ψ_f`

**补偿公式**:
```c
v_d_ff = -omega_e * Lq * i_q;
v_q_ff = omega_e * (Ld * i_d + psi_f);

v_d_out = pid_d_out + v_d_ff;
v_q_out = pid_q_out + v_q_ff;
```

**所需参数**:
- 电机电感 Ld, Lq
- 永磁体磁链 ψ_f
- 电角速度 ω_e

---

## 5. 死区补偿

**目标**: 补偿逆变器死区导致的电流畸变

**问题分析**:
- 死区时间内上下管同时关断
- 实际输出电压与指令电压存在偏差
- 导致电流波形畸变，产生 5/7 次谐波

**补偿方法**:
```c
// 根据电流方向补偿
if (i_a > threshold)
    duty_a += dead_time_comp;
else if (i_a < -threshold)
    duty_a -= dead_time_comp;
// i_b, i_c 同理
```

**补偿量计算**:
```
ΔD = T_dead / T_pwm
```

**注意事项**:
- 电流过零点附近需要平滑过渡
- 补偿量需要根据实际死区时间标定

---

## 6. 弱磁控制

**目标**: 扩展电机高速运行范围

**原理**:
- 高速时反电动势接近母线电压，电流环饱和
- 注入负 i_d 电流削弱磁场，降低反电动势
- 牺牲部分转矩换取更高转速

**实现方式**:

方式一: 电压反馈弱磁
```c
// 检测电压裕量
v_mag = sqrt(v_d*v_d + v_q*v_q);
v_max = U_DC / sqrt(3);

if (v_mag > 0.95 * v_max) {
    // PI 调节器输出负 i_d 参考
    i_d_ref = pi_fw(v_max * 0.95, v_mag);
}
```

方式二: 查表法
- 根据转速查表获取 i_d 参考值

**约束条件**:
- 电压圆: `v_d² + v_q² ≤ V_max²`
- 电流圆: `i_d² + i_q² ≤ I_max²`
- MTPA 曲线 (IPM 电机)

---

## 开发优先级

| 优先级 | 功能 | 预计工作量 | 依赖 |
|--------|------|------------|------|
| P0 | 串口命令 | 2-3 天 | 无 |
| P1 | 前馈解耦 | 1 天 | 电机参数辨识 |
| P1 | 死区补偿 | 1 天 | 无 |
| P2 | 位置闭环 | 2 天 | 无 |
| P3 | 弱磁控制 | 2-3 天 | 前馈解耦 |
| P4 | 滑模观测器 | 5-7 天 | 前馈解耦 |

---

## 备注

- 滑模观测器开发前建议先完成前馈解耦，确保电流环性能
- 弱磁控制需要准确的电机参数，建议先做参数辨识
- 所有新功能建议先在低速/轻载下验证
