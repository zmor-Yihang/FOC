

# 按键按下导致过流原因分析

## 问题代码

```c
/* 关闭速度环 */
speed_loop_enable = 0;

/* 停止PWM输出 */
tim1_set_pwm_duty(0, 0, 0);
```

---

## 原因分析

### 1. 占空比为0导致三相下桥臂短路

| 占空比 | 高侧MOS | 低侧MOS | 状态 |
|--------|---------|---------|------|
| `0%` | 关闭 | 导通 | **三相短接到GND** |
| `50%` | 半周期导通 | 半周期导通 | 中点电压，安全 |

- 设置占空比为0时，三相下桥臂MOS全部导通
- 电机反电动势通过下桥臂形成短路回路
- 产生极大的短路电流

### 2. 电机感性负载特性

- 电机绕组储能：$E = \frac{1}{2}LI^2$
- 电流无法瞬间归零
- 能量必须通过某条路径释放

### 3. 竞态条件

```c
speed_loop_enable = 0;      // ← ISR可能正在执行foc_loop
tim1_set_pwm_duty(0, 0, 0); // ← ISR可能刚写入新占空比
```

- 主循环与ADC中断存在竞争
- 可能导致短暂的异常输出

---

## 解决方案

### 方案一：设置安全占空比（推荐）

```c
tim1_set_pwm_duty(50.0f, 50.0f, 50.0f);  // 中点电压，电机自由滑行
```

### 方案二：禁用主输出使能

```c
__HAL_TIM_MOE_DISABLE(&htim1);  // 关闭MOE，所有MOS关断
```

### 方案三：软停机流程

```c
// 1. 目标速度归零
target_speed_final = 0.0f;

// 2. 等待减速
while (actual_speed > 1.0f) {
    delay_ms(10);
}

// 3. 关闭控制环
speed_loop_enable = 0;

// 4. 安全关闭输出
__HAL_TIM_MOE_DISABLE(&htim1);
```

### 方案四：原子操作保护

```c
__disable_irq();
speed_loop_enable = 0;
tim1_set_pwm_duty(50.0f, 50.0f, 50.0f);
__enable_irq();
```

---

## 总结

| 问题 | 原因 | 解决方法 |
|------|------|----------|
| 占空比为0 | 下桥臂全导通，三相短路 | 使用50%占空比或禁用MOE |
| 感性负载 | 电流无法突变，续流导致过流 | 提供安全续流路径 |
| 竞态条件 | 主循环与ISR竞争 | 关中断保护 |
| 突然停机 | 电机惯性产生反电动势 | 软停机减速 |